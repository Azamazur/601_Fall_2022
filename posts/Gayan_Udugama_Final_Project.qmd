---
title: "NYC Insurance Project "
author: "Gayan Udugama"
desription: "Final Project- Gayan Udugama"
date: "12/20/2022"
format:
  html:
    toc: true
    code-fold: true
    code-copy: true
    code-tools: true
categories:
  - Final Project
  - Gayan Udugama
---

```{r}
#| echo: true 
#| label: load packages 
#| warning: false
#| message: false
#| include: false
#| code-summary: "packages"

#rm(list = ls())

library(here)
library(rgeos)
library(raster)
library(tidyverse)    #for data wrangling and visualization 
library(ggplot2)
library(sf)
library(rmapshaper)
library(nngeo)
library(stargazer)
library(knitr)        #for tables 
library(readxl)# read csv
library(pacman) # install update and load packages 
library(data.table) # use the fread() function 
library(stringr) # the package with str_ditect 
library(lubridate)

```

### Introduction

As a fourth-year PhD student in the Department of Resource Economics, I am currently working on a chapter of my dissertation project. I have primarily used STATA and Arc GIS for my analysis in the past, but I am now transitioning to R for efficiency and to make it easier to revise my analysis. Though it was very frustrating I learned a lot during this semester. This class has been very helpful in learning how to use R for my project. The following is a brief introduction to the project and its objectives.

As climate change continues to intensify, the future looks increasingly grim for our planet. One of the most significant impacts of this phenomenon is an increase in flooding, which can have serious consequences for individuals and communities. Rising sea levels and increased rainfall intensity are expected to contribute to the growing frequency and intensity of these flooding events.

In 1968, the US government launched the National Flood Insurance Program (NFIP) to provide insurance coverage for flood-prone areas. The program is managed by the Federal Emergency Management Agency (FEMA) and is delivered to the public by approximately 60 insurance companies. There are about 23,000 participating NFIP communities. The United States Army Corps of Engineers (USACE) flood maps divide each part of communities as falling into approx. 10 flood zones. Each zone pays different premium rates- the highest for a 100-year flood plain. Homeowners must decide yearly whether to buy the insurance or drop out of the program.

Hurricane Sandy, which occurred on October 22-31 in 2012, is considered to be the second-costliest hurricane in US history it impacted the entire east coast of the US. The damages and lost economic activity in New York alone are estimated to be at \\\$19 billion. In this paper, we look at how "Hurricane Sandy" (Sandy) affected the residential insurance take-up in New York City, USA.

### Research Questions

\section{Research Question}

In this study, we are interested in studying the impact of Sandy on the insurance behavior of households. In particular, we will analyze the following research questions:

-   **Broad question:** Does the likelihood of insurance purchase increase as additional information on increasing risks becomes available?

-   **Narrow question:** Have revelations of flood risk in NYC led to increases in the purchase of flood insurance?

-   **Specific question:** How are flood insurance take-up rates in NYC impacted by experience with flooding due to Sandy?

### Loading the data

n this section, we will discuss the data that will be used in the project. The data sources include the National Flood Insurance Program (NFIP) data for NYC, the primary Land Use Tax Lot Output (PLUTO) for NYC, and the Hurricane Sandy flood inundation maps for NYC.

The NFIP data is a yearly panel that contains insurance information at the household level from 2004 to 2017. This data was obtained through a request under the right to information Act. This was given to me by my adviser so I a unable to share this in the blog. The PLUTO data is a publicly available dataset on the NYC.gov website that provides detailed information about land use and tax data in the city. The Hurricane Sandy flood maps provide information about the areas that were inundated during the Hurricane.

All of these data sources will be used to analyze the impact of flood insurance on household decision-making in the context of a major flood event. The analysis will focus on the changes in the uptake of flood insurance before and after Hurricane Sandy, as well as the spatial distribution of insured and uninsured households in the city. The results of this analysis will provide valuable insights into the effectiveness of flood insurance as a risk management tool and may inform future policy decisions related to flood risk management in the USA.\\footnote{https://www1.nyc.gov/}. We shall be focusing our attention on residential data.

```{r}
#| echo: true 
#| warning: false
#| message: false

# setting the working directory 
setwd("C:/Users/gkudu/Dropbox/Dump_Sri_Lanka/NYC_Project")

#loading the Geo-coded insurance data
#FEAP_data <- read_sf(dsn ="data_GIS/Geocoded_2018_FEAP_data",
                    # layer ="Geocoded_2018_FEAP_data")

FEAP_data_csv <- read_csv("data/2018-FEAP-00029.csv")


```

```{r}
#| echo: true 
#| label: load-data 
#| warning: false
#| message: false

# This is a complete list of address information in NYC- this need to be mereged with the FEAP data prior to running a regression. After geo-coding this data, Hurricane sandy data has to be incorporated into this. 

pluto = fread("C:/Users/gkudu/Dropbox/Dump_Sri_Lanka/NYC_Project/data/nyc_pluto_22v1_csv/pluto_22v1.csv")
head(pluto)

#loading Demographic Statistics By Zip Code
demo <- read.csv("C:/Users/gkudu/Dropbox/Dump_Sri_Lanka/NYC_project/data/Demographic_Statistics_By_Zip_Code.csv")

```

### Data wrangling

In this section I will be cleaning the data

```{r}

# covert the data into a lower case 
FEAP <- data.frame(lapply(FEAP_data_csv, function(v){
  # the E function converts each value in a column to lowercase if it is a character value,
  # and leaves it unchanged if it is not a character value
  if (is.character(v)) 
    return(tolower(v))
  else 
    return(v)
}))

##### changing variables names to lower case in r
names(FEAP) <- tolower(names(FEAP))

head(FEAP)
str(FEAP)  #checking the variable type 

# Dates are in str format. converting them into date format 

##### Convert date "str" into "Date" format
FEAP <- FEAP %>% 
  mutate(as_of_date = mdy(as_of_dt),
         pol_eff_date = mdy(pol_eff_dt),
         pol_exp_date = mdy(pol_exp_dt),
         year= year(pol_eff_date))

counts_by_occupation <- FEAP %>% 
  group_by(occupancy,year) %>% 
  summarise(count = n()) %>% 
  arrange(year)

# Convert the output to wide format
counts_by_occupation_wide <- counts_by_occupation %>%
  pivot_wider(names_from = year, values_from = count)
 

# Print the results
head(counts_by_occupation_wide)
```

We are working only with residential data- so filtering only the residential data

```{r}
## getting only the residential addresses in the data frame
unique(FEAP$occupancy) ## checking the unique levels in occupancy 

FEAP <- FEAP %>% 
  filter(occupancy %in% c("residential  1  fam", "residential   2 - 4 fam", "other-residential")) %>% 
  mutate(occu = "residential")

unique(FEAP$occupancy) 
```

### Analysis

```{r}
## counting number of unique addresses in terms of address 1 address2 and zipcode 

FEAP %>% 
  select(address1,address2, zip5)%>%
  n_distinct()

# 67879 addresses in-terms of address1,address2, zip5

FEAP %>% 
  select(address1,address2)%>%
  n_distinct()

# 67387 addresses in-terms of address1,address2

FEAP %>% 
  select(address2,zip5)%>%
  n_distinct()

# 65590 addresses in-terms of address2 and zip5

## creating a data frame only with unique addresses 

unique_nfip <-  FEAP %>% 
  group_by(address2,zip5)%>% 
  summarise(count_obs= n())

unique_nfip <-  unique_nfip[order(-unique_nfip$count_obs,unique_nfip$zip5),] ## sort on count_obs and zip

head(unique_nfip)
summary
```

```{r}
## plotting addresses to see its distribution  
hist(unique_nfip$count_obs,
     main = " distribution of unique addresses interms of address 2 and zipcode",
     xlim = c(1,87))

```

```{r}
length(which(unique_nfip$count_obs>20)) ## counting the number of addresses with more than 20 records 
```

```{r}
#| warning: false
#| message: false
#| include: true


# he plot shows the average insurance premium over time, with a red line demarcating the time when Hurricane Sandy occurred
## ploting the avarage insurance premium overtime 
FEAP %>%
  group_by(year) %>% 
  summarise(mean_insu = mean(t_premium)) %>% 
  ggplot(aes(x = year, y = mean_insu))+
  geom_point()+
  geom_line()+
  geom_vline(xintercept = 2013, color = "red") +
  xlab("Year")+
  ylab("Insurance premium ($)")+
  labs(title = "Insurance premium over time") +
  scale_x_discrete(limits = unique(FEAP$year)) +
  theme(text = element_text(size = 12))

```

```{r}
### joining the demographic information into the insurance data at zip code level

# changing variables names to lower case in r
names(demo) <- tolower(names(demo))

#renaming the common variable 
demo <- demo %>%
  rename(zip5 = jurisdiction.name)

# join
FEAP_join <- left_join(FEAP,demo, by = "zip5")
head(FEAP_join)
```

### Conclusion and Way forward

Over time, the insurance premiums have been steadily increasing. However, there is a slight decrease in premiums in 2013 when Hurricane Sandy occurred. After 2016, there is a significant reduction in mean premium value. In the future, I plan to continue this project to investigate the impact of Hurricane Sandy on insurance premiums, and to ask more nuanced questions such as how the storm affected minority communities in New York City.
